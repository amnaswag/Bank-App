@inject AccessService AccessService
@inject NavigationManager NavManager

@implements IDisposable

@if (AccessService.IsLoggedIn)
{
    @ChildContent
}
else
{
    <LoginPage />
}

@code {
    /// <summary>
    /// The content to protect (the routed Blazor page).
    /// </summary>
    [Parameter]
    public RenderFragment ChildContent { get; set; }

    /// <summary>
    /// Lifecycle method: performs redirect check and subscribes to login events.
    /// </summary>
    protected override void OnInitialized()
    {
        // Check if the user is logged out and NOT already on the /login page.
        if (!AccessService.IsLoggedIn)
        {
            // Force a redirect to /login to show LoginPage.razor
            if (!NavManager.Uri.EndsWith("/login", StringComparison.OrdinalIgnoreCase))
            {
                NavManager.NavigateTo("/login", replace: true);
            }
        }
        
        // Subscribe to the event so the component re-renders when login succeeds
        AccessService.OnChange += StateHasChanged;
    }

    /// <summary>
    /// Unsubscribes from the event on dispose to avoid memory leaks.
    /// </summary>
    public void Dispose()
    {
        AccessService.OnChange -= StateHasChanged;
    }
}
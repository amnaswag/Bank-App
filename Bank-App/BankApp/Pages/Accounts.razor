@page "/Accounts"
@inject IAccountService AccountService
@inject IJSRuntime JsRuntime

<h3>Konton</h3>

<!-- Action buttons: export, import (hidden file input + label), apply interest -->
<div class="mb-3 d-flex justify-content-end gap-2">
    <!-- Export accounts as JSON -->
    <button class="btn btn-info" @onclick="ExportDataAsync">Exportera till JSON</button>
    
    <!-- Hidden file input used for importing JSON; label triggers it -->
    <InputFile OnChange="LoadDataAsync" id="importFile" hidden />
    <label for="importFile" class="btn btn-warning">Importera från JSON</label>

    <!-- Apply interest action for savings accounts -->
    <button class="btn btn-success" @onclick="ApplyInterestAsync">Applicera 0.5% Ränta (Sparkonton)</button>
</div>

<!-- Display a status message if present; style depends on error flag -->
@if (!string.IsNullOrEmpty(_message))
{
    <div class="alert @(_isError ? "alert-danger" : "alert-success")">@_message</div>
}

<!-- Loading state: show while accounts are null -->
@if (_accounts == null)
{
    <p>Laddar konton...</p>
}

<!-- Empty state: no accounts available -->
else if (!_accounts.Any())
{
    <div class="alert alert-info" role="alert">
        Inga konton registrerade. Gå till <a href="CreateAccount">Skapa konto</a> för att lägga till ett nytt.
    </div>
}
else
{
    <!-- Accounts table: lists each account with actions -->
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Namn</th>
                <th>Typ</th>
                <th>Valuta</th>
                <th>Saldo</th>
                <th>Senast Uppdaterad</th>
                <th>Åtgärd (PIN)</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var account in _accounts)
            {
                <!-- Determine if the account balance is locked (PIN-protected and not unlocked this session) -->
                var isLocked = !string.IsNullOrEmpty(account.PinHash) && !AccountService.IsAccountUnlocked(account.Id);
                
                <tr>
                    <!-- Account name -->
                    <td><strong>@account.Name</strong></td>

                    <!-- Human readable account type -->
                    <td>@GetAccountTypeName(account.AccountType)</td>

                    <!-- Currency code -->
                    <td>@account.Currency</td>

                    <!-- Balance: show "Locked" if locked, otherwise formatted currency -->
                    <td>
                        <span class="badge bg-success">
                            @(isLocked ? "Låst" : account.Balance.ToString("C2", new System.Globalization.CultureInfo("sv-SE")))
                        </span>
                    </td>

                    <!-- Last updated timestamp -->
                    <td>@account.LastUpdated.ToString("yyyy-MM-dd HH:mm")</td>

                    <!-- Action cell: show unlock button only when account is locked -->
                    <td>
                        @if (isLocked)
                        {
                            <button class="btn btn-secondary btn-sm" @onclick="() => ShowUnlockPrompt(account.Id)">Lås Upp Saldo</button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

<!-- PIN unlock UI shown when _showUnlockPrompt is true -->
@if (_showUnlockPrompt)
{
    <div class="card p-3 mt-3 shadow-lg">
        <h5>Lås upp konto</h5>

        <!-- PIN input field (password) -->
        <div class="mb-3">
            <label class="form-label">PIN-kod (Siffror)</label>
            <InputText @bind-Value="_unlockPin" class="form-control" type="password" maxlength="6" />
        </div>

        <!-- Unlock error message if present -->
        @if (!string.IsNullOrEmpty(_unlockMessage))
        {
            <div class="alert alert-danger">@_unlockMessage</div>
        }

        <!-- Verify and cancel buttons -->
        <div class="d-flex gap-2">
            <button class="btn btn-primary" @onclick="UnlockAccountAsync">Verifiera</button>
            <button class="btn btn-danger" @onclick="CloseUnlockPrompt">Avbryt</button>
        </div>
    </div>
}

@code {
    // Backing fields
    private List<IBankAccount> _accounts;
    private string _message = string.Empty;      // General status message shown to user
    private bool _isError = false;               // If true, _message is treated as an error
    private bool _showUnlockPrompt = false;      // Controls visibility of the PIN prompt UI
    private Guid _accountIdToUnlock;             // Id of the account to attempt unlocking
    private string _unlockPin = string.Empty;    // User-entered PIN for unlocking
    private string _unlockMessage = string.Empty;// Error message specific to unlocking

    /// <summary>
    /// Helper method to convert the AccountType enum to a Swedish display name.
    /// </summary>
    private string GetAccountTypeName(AccountType type)
    {
        return type switch
        {
            AccountType.SalaryAccount => "Lönekonto",
            AccountType.SavingsAccount => "Sparkonto",
            _ => type.ToString(), // Fallback to enum name if not mapped
        };
    }

    /// <summary>
    /// Lifecycle method: loads accounts when the component initializes.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        await LoadAccountsAsync();
    }
    
    /// <summary>
    /// Prepares and shows the unlock prompt for the selected account.
    /// Resets previous PIN and messages.
    /// </summary>
    private void ShowUnlockPrompt(Guid accountId)
    {
        _accountIdToUnlock = accountId;
        _unlockPin = string.Empty;
        _unlockMessage = string.Empty;
        _showUnlockPrompt = true;
    }

    /// <summary>
    /// Closes the unlock prompt and clears related messages.
    /// </summary>
    private void CloseUnlockPrompt()
    {
        _showUnlockPrompt = false;
        _unlockMessage = string.Empty;
    }
    
    /// <summary>
    /// Attempts to unlock the account by verifying the PIN via the AccountService.
    /// On success: closes prompt, sets a success message and reloads accounts.
    /// On failure: sets an unlock-specific error message.
    /// </summary>
    private async Task UnlockAccountAsync()
    {
        if (await AccountService.UnlockAccountAsync(_accountIdToUnlock, _unlockPin))
        {
            CloseUnlockPrompt();
            _message = $"Konto {_accounts.FirstOrDefault(a => a.Id == _accountIdToUnlock)?.Name} är nu upplåst i denna session.";
            _isError = false;
            await LoadAccountsAsync(); 
        }
        else
        {
            _unlockMessage = "Felaktig PIN-kod.";
        }
    }

    /// <summary>
    /// Loads the latest accounts list from the injected service.
    /// </summary>
    private async Task LoadAccountsAsync()
    {
        _accounts = await AccountService.GetAccountsAsync();
    }

    /// <summary>
    /// Applies 0.5% interest to qualifying accounts through the service and reloads data.
    /// Sets a success or error message based on the service result.
    /// </summary>
    private async Task ApplyInterestAsync()
    {
        _message = string.Empty;
        // The interest rate is passed as a decimal (0.5% = 0.005)
        var result = await AccountService.ApplyInterestAsync(0.005M); 
        
        if (string.IsNullOrEmpty(result))
        {
            _message = "Ränta på 0.5% applicerades framgångsrikt på alla upplåsta Sparkonton.";
            _isError = false;
        }
        else
        {
            _message = result;
            _isError = true;
        }
        await LoadAccountsAsync();
    }

    /// <summary>
    /// Exports account data as JSON and triggers a browser download via JS interop.
    /// </summary>
    private async Task ExportDataAsync()
    {
        _message = string.Empty;
        var json = await AccountService.ExportDataToJsonAsync();
        var fileName = $"BankApp_Export_{DateTime.Now:yyyyMMdd_HHmmss}.json";

        // Calls a JS function (BlazorDownloadFile) to start the download
        await JsRuntime.InvokeVoidAsync("BlazorDownloadFile", fileName, json, "application/json");
        _message = "Data exporterades framgångsrikt som JSON.";
        _isError = false;
    }

    /// <summary>
    /// Handles import from a selected file: reads JSON, passes it to the service,
    /// and handles success/error cases including file-size/read errors.
    /// </summary>
    private async Task LoadDataAsync(InputFileChangeEventArgs e)
    {
        _message = string.Empty;
        _isError = false;

        var file = e.File;
        if (file == null) return;
        
        try
        {
            // Limit read stream to 5 MB
            using var reader = new StreamReader(file.OpenReadStream(maxAllowedSize: 1024 * 1024 * 5));
            var jsonData = await reader.ReadToEndAsync();

            var result = await AccountService.ImportDataFromJsonAsync(jsonData);
            if (string.IsNullOrEmpty(result))
            {
                _message = "Data importerades framgångsrikt. Applikationen har uppdaterats.";
                _isError = false;
                await LoadAccountsAsync();
            }
            else
            {
                _message = result;
                _isError = true;
            }
        }
        catch (IOException ex)
        {
            // File too large or read error
            _message = $"Filen är för stor eller kunde inte läsas: {ex.Message}";
            _isError = true;
        }
        catch (Exception ex)
        {
            // Generic error handling for import process
            _message = $"Ett fel uppstod under importen: {ex.Message}";
            _isError = true;
        }
    }
}